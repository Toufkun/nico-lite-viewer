<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>ãƒ‹ã‚³ãƒ‹ã‚³ç°¡æ˜“ãƒ“ãƒ¥ãƒ¼ã‚¢ï¼ˆãƒ€ãƒ¼ã‚¯ + ãƒ‡ãƒ¢å†ç”Ÿï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="referrer" content="no-referrer-when-downgrade" />
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#ffffff; --fg:#0f172a; --muted:#6b7280; --card:#ffffff; --border:#e5e7eb;
      --accent:#2563eb; --hover:#f8fafc; --thumb-bg:#0b0b0b; --shadow:0 6px 20px rgba(0,0,0,.08);
    }
    :root.dark{
      --bg:#0b0f19; --fg:#e5e7eb; --muted:#9aa4b2; --card:#111827; --border:#1f2937;
      --accent:#60a5fa; --hover:#0f172a; --thumb-bg:#000; --shadow:0 8px 28px rgba(0,0,0,.35);
    }
    @media (prefers-color-scheme:dark){
      :root:not(.light){
        --bg:#0b0f19; --fg:#e5e7eb; --muted:#9aa4b2; --card:#111827; --border:#1f2937;
        --accent:#60a5fa; --hover:#0f172a; --thumb-bg:#000; --shadow:0 8px 28px rgba(0,0,0,.35);
      }
    }

    body{
      margin:24px; max-width:1000px; margin-inline:auto;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      background:var(--bg); color:var(--fg); transition:.2s;
    }
    h1{ display:flex; align-items:center; gap:10px; margin-bottom:16px; }
    .muted{ color:var(--muted); }

    #bar{ display:grid; grid-template-columns:1fr 140px 120px auto auto; gap:10px; }
    input, select, button{
      padding:10px 12px; border-radius:10px; border:1px solid var(--border);
      background:var(--card); color:var(--fg); font-size:15px;
    }
    button.primary{ background:var(--accent); color:#fff; border:none; cursor:pointer; }
    button.ghost{ cursor:pointer; background:transparent; border:1px solid var(--border); }
    #err{ color:#ef4444; margin-top:6px; }

    .grid{ margin-top:20px; display:grid; grid-template-columns:repeat(auto-fill,minmax(190px,1fr)); gap:14px; }
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:12px;
      padding:8px; cursor:pointer; transition:.1s; box-shadow:var(--shadow);
    }
    .card:hover{ transform:translateY(-2px); background:var(--hover); }
    .thumb{ width:100%; aspect-ratio:16/9; object-fit:cover; border-radius:10px; background:var(--thumb-bg); }
    .meta{ margin-top:6px; font-size:13px; color:var(--muted); }

    #player-wrap{ margin-top:28px; }
    .frame{ position:relative; padding-bottom:56.25%; height:0; background:#000; border-radius:14px; overflow:hidden; box-shadow:var(--shadow); }
    #mount{ position:absolute; inset:0; }

    #links{ margin-top:8px; font-size:14px; }
    a{ color:var(--accent); text-decoration:none; }
    a:hover{text-decoration:underline;}

    @media(max-width:640px){
      body{ margin:16px; }
      #bar{ grid-template-columns:1fr auto auto auto auto; }
    }
  </style>
</head>
<body>

<h1>
  ãƒ‹ã‚³ãƒ‹ã‚³å‹•ç”»ãƒ“ãƒ¥ãƒ¼ã‚¢
  <span class="muted">ãƒ€ãƒ¼ã‚¯ + ãƒ‡ãƒ¢å¯¾å¿œ</span>
  <button id="themeBtn" class="ghost" title="ãƒ†ãƒ¼ãƒåˆ‡æ›¿">ğŸŒ™</button>
</h1>

<div id="bar">
  <input id="q" placeholder="ä¾‹ï¼šsm9 / åˆéŸ³ãƒŸã‚¯">
  <select id="sort">
    <option value="popular">äººæ°—é †</option>
    <option value="new">æ–°ç€é †</option>
    <option value="comments">ã‚³ãƒ¡ãƒ³ãƒˆé †</option>
  </select>
  <button id="btn" class="primary">æ¤œç´¢</button>
  <label style="display:flex;align-items:center;gap:6px;">
    <input type="checkbox" id="demoToggle">
    <span class="muted">ãƒ‡ãƒ¢å†ç”Ÿ</span>
  </label>
</div>

<div id="err"></div>
<div id="results" class="grid"></div>

<div id="player-wrap">
  <div class="frame"><div id="mount"></div></div>
  <div id="links"></div>
</div>

<script>
/* === Theme === */
const root = document.documentElement;
const themeBtn = document.getElementById("themeBtn");
const saved = localStorage.getItem("theme");
applyTheme(saved||"auto");
function applyTheme(mode){
  root.classList.remove("light","dark");
  if(mode==="dark"){root.classList.add("dark");themeBtn.textContent="â˜€ï¸";}
  else if(mode==="light"){root.classList.add("light");themeBtn.textContent="ğŸŒ™";}
  else{themeBtn.textContent=matchMedia("(prefers-color-scheme:dark)").matches?"â˜€ï¸":"ğŸŒ™";}
}
themeBtn.onclick=()=>{
  const cur = localStorage.getItem("theme")||"auto";
  const next = cur==="auto"?"dark":cur==="dark"?"light":"auto";
  localStorage.setItem("theme",next);
  applyTheme(next);
};

/* === Search === */
const q=document.getElementById("q"), s=document.getElementById("sort"), btn=document.getElementById("btn");
const results=document.getElementById("results"), err=document.getElementById("err");
btn.onclick=()=>search();
q.onkeydown=e=>{if(e.key==="Enter")search();};

async function search(){
  const qv=q.value.trim(); if(!qv)return;
  results.innerHTML="æ¤œç´¢ä¸­â€¦"; err.textContent="";
  try{
    const url=new URL("/api/search",location.origin);
    url.searchParams.set("q",qv);
    url.searchParams.set("sort",s.value);
    url.searchParams.set("limit","24");
    const r=await fetch(url); const j=await r.json();
    if(!j.ok) throw new Error(j.error);
    if(!j.items.length){results.innerHTML="è©²å½“ãªã—";return;}
    results.innerHTML=j.items.map(v=>`
      <div class="card" onclick="play('${v.id}','${encodeURIComponent(v.title)}')">
        <img class="thumb" src="${v.thumb}">
        <div class="meta">
          <div style="color:var(--fg)">${v.title}</div>
          <div>å†ç”Ÿ ${Number(v.views).toLocaleString()} / ã‚³ãƒ¡ ${Number(v.comments).toLocaleString()}</div>
        </div>
      </div>
    `).join("");
  }catch(e){err.textContent=e.message;results.innerHTML="";}
}

/* === Play (with DEMO fallback) === */
const mount=document.getElementById("mount"), links=document.getElementById("links");
window.play=async function(id,titleEnc=""){
  const demo=document.getElementById("demoToggle").checked;
  // ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ â†’ ãƒ­ãƒ¼ã‚«ãƒ«å‹•ç”»
  if(demo){
    mount.innerHTML=`<video src="/demo.mp4" controls style="width:100%;height:100%;background:#000"></video>`;
    links.innerHTML=`ãƒ‡ãƒ¢å†ç”Ÿä¸­`;
    return;
  }

  try{
    const r=await fetch(`/api/parse?q=${id}`); const j=await r.json();
    if(!j.ok) throw new Error(j.error);
    mount.innerHTML="";

    let usedScript=false;
    try{
      await new Promise((res,rej)=>{
        const s=document.createElement("script");
        s.src=j.script; s.onload=res; s.onerror=()=>rej(0);
        mount.appendChild(s);
        setTimeout(()=>rej(0),2000);
      });
      usedScript=true;
    }catch{
      const f=document.createElement("iframe");
      f.src=`https://embed.nicovideo.jp/watch/${j.id}?jsapi=1`;
      f.style=`width:100%;height:100%;border:0`;
      f.allow="autoplay; fullscreen; picture-in-picture";
      f.referrerPolicy="no-referrer-when-downgrade";
      mount.innerHTML=""; mount.appendChild(f);
    }

    const title=decodeURIComponent(titleEnc);
    links.innerHTML=`å†ç”Ÿä¸­: ${title}<br><a href="${j.watch}" target="_blank">ãƒ‹ã‚³ãƒ‹ã‚³ã§é–‹ã</a>`;

  }catch(e){
    // æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ â†’ ãƒ­ãƒ¼ã‚«ãƒ«å‹•ç”»
    mount.innerHTML=`<video src="/demo.mp4" controls style="width:100%;height:100%;background:#000"></video>`;
    links.innerHTML=`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸãŸã‚ãƒ‡ãƒ¢å†ç”Ÿã«åˆ‡æ›¿ãˆã¾ã—ãŸ`;
  }
};
</script>
</body>
</html>
