<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>ニコニコ簡易ビューア</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- 一部の環境で埋め込みが参照することがある -->
  <meta name="referrer" content="no-referrer-when-downgrade" />
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; max-width: 1000px; }
    h1 { margin-bottom: 12px; }
    #controls { display: grid; grid-template-columns: 1fr 140px 120px; gap: 8px; }
    input, select, button { padding: 10px; font-size: 16px; }
    button { cursor: pointer; }
    #err { color: #d00; margin-top: 10px; min-height: 1.2em; }

    .grid { margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(180px,1fr)); gap: 12px; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 6px; cursor: pointer; transition: .15s; background:#fff; }
    .card:hover { background: #fafafa; }
    .thumb { width: 100%; aspect-ratio: 16/9; object-fit: cover; border-radius: 6px; display:block; }
    .meta { margin-top: 6px; font-size: 13px; color:#555; }

    #player-wrap { margin-top: 28px; }
    .frame { position: relative; padding-bottom: 56.25%; height: 0; background: #000; border-radius: 10px; overflow: hidden; }
    #mount { position: absolute; inset: 0; width: 100%; height: 100%; }
    #links { margin-top: 8px; font-size: 14px; }
    a { color:#0366d6; text-decoration: none; }
  </style>
</head>
<body>

<h1>ニコニコ動画 検索ビューア</h1>

<div id="controls">
  <input id="q" placeholder="例：初音ミク / sm9 など">
  <select id="sort">
    <option value="popular">人気順</option>
    <option value="new">新着順</option>
    <option value="comments">コメント多い順</option>
  </select>
  <button id="btn">検索</button>
</div>

<div id="err"></div>

<div id="results" class="grid"></div>

<div id="player-wrap">
  <div class="frame"><div id="mount"></div></div>
  <div id="links"></div>
</div>

<script>
  const qEl = document.getElementById('q');
  const sEl = document.getElementById('sort');
  const btn = document.getElementById('btn');
  const results = document.getElementById('results');
  const err = document.getElementById('err');
  const mount = document.getElementById('mount');
  const links = document.getElementById('links');

  btn.addEventListener('click', () => doSearch());
  qEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') doSearch(); });

  async function doSearch(offset = 0) {
    try {
      err.textContent = '';
      results.innerHTML = '検索中…';
      const q = qEl.value.trim();
      if (!q) { results.innerHTML=''; return; }

      const url = new URL('/api/search', location.origin);
      url.searchParams.set('q', q);
      url.searchParams.set('sort', sEl.value);
      url.searchParams.set('offset', String(offset));
      url.searchParams.set('limit', '24');

      const r = await fetch(url);
      const j = await r.json();
      if (!j.ok) throw new Error(j.error || 'search failed');

      if (!j.items.length) { results.innerHTML = '<div>該当なし</div>'; return; }

      results.innerHTML = j.items.map(v => `
        <div class="card" onclick="play('${v.id}', '${encodeURIComponent(v.title)}')">
          <img class="thumb" src="${v.thumb}" alt="">
          <div class="meta">
            <div>${v.title}</div>
            <div>再生 ${Number(v.views||0).toLocaleString()} / コメ ${Number(v.comments||0).toLocaleString()}</div>
          </div>
        </div>
      `).join('');
    } catch (e) {
      console.error(e);
      err.textContent = e.message;
      results.innerHTML = '';
    }
  }

  // --- 再生：script優先 → 失敗時は自動的に iframe に切替
  window.play = async function(id, titleEnc='') {
    try {
      const r = await fetch(`/api/parse?q=${id}`);
      const j = await r.json();
      if (!j.ok) throw new Error(j.error || 'parse failed');

      mount.innerHTML = '';
      links.innerHTML = '';

      // script方式を試す
      let usedScript = false;
      try {
        await new Promise((resolve, reject) => {
          const s = document.createElement('script');
          s.type = 'application/javascript';
          s.src = j.script; // https://embed.nicovideo.jp/watch/ID/script?w=1280&h=720
          s.onload = () => resolve();
          s.onerror = () => reject(new Error('script embed failed'));
          mount.appendChild(s);
          setTimeout(() => reject(new Error('script timeout')), 2500);
        });
        usedScript = true;
      } catch (_) {
        // iframeフォールバック
        const iframe = document.createElement('iframe');
        iframe.src = `https://embed.nicovideo.jp/watch/${j.id}?jsapi=1`;
        iframe.style.width = '100%';
        iframe.style.height = '100%';
        iframe.style.border = '0';
        iframe.allow = 'autoplay; fullscreen; picture-in-picture; encrypted-media';
        iframe.referrerPolicy = 'no-referrer-when-downgrade';
        mount.appendChild(iframe);
      }

      const title = decodeURIComponent(titleEnc || '');
      links.innerHTML = `
        ${title ? '再生中: ' + title : ''}<br>
        <a href="${j.watch}" target="_blank" rel="noreferrer">ニコニコで開く</a>
        / <a href="https://embed.nicovideo.jp/watch/${j.id}?jsapi=1" target="_blank" rel="noreferrer">埋め込みを別タブで開く</a>
        / <a href="#" id="reload">プレイヤーを更新</a>
      `;

      // ワンクリック切替
      document.getElementById('reload').onclick = (e) => {
        e.preventDefault();
        if (usedScript) {
          mount.innerHTML = `
            <iframe src="https://embed.nicovideo.jp/watch/${j.id}?jsapi=1"
              style="width:100%;height:100%;border:0"
              allow="autoplay; fullscreen; picture-in-picture; encrypted-media"
              referrerpolicy="no-referrer-when-downgrade"
              loading="lazy"></iframe>`;
          usedScript = false;
        } else {
          mount.innerHTML = '';
          const s = document.createElement('script');
          s.src = j.script;
          mount.appendChild(s);
          usedScript = true;
        }
      };
    } catch (e) {
      console.error(e);
      err.textContent = e.message;
    }
  };
</script>

</body>
</html>
